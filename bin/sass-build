#!/usr/bin/env node

const path = require("path")
const fs = require("fs")
const sass = require("sass")
const { optimize } = require("svgo")

const args = process.argv.slice(2)
if (args.length < 2) {
  console.error("Usage: bin/sass-build <inputFile> <outputFile>")
  process.exit(1)
}
const inputFile = path.resolve(args[0])
const outputFile = path.resolve(args[1])

const basePath = path.dirname(inputFile)

const functions = {
  "svg($file)": (svgFileName) => {
    const filename = path.resolve(basePath, svgFileName.getValue())

    let svgContent = fs.readFileSync(filename, "utf8")
    svgContent = optimize(svgContent, { multipass: true, datauri: "enc" })

    return new sass.SassString(`url("${svgContent.data}")`, { quotes: false })
  },
}

sass.render(
  {
    file: inputFile,
    functions
  },
  (err, result) => {
    if (err) {
      console.error("Error compiling SCSS:", err)
    } else {
      fs.writeFileSync(outputFile, result.css, "utf8")
    }
  }
)
